// JS code trimmed for brevity - refer to combined version